<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Space Power — Press Tracker</title>
<meta name="description" content="Space Power — press space or click to track your score and compete globally.">
<style>
  :root{--bg:#071023;--card:#0b1220;--muted:#94a3b8;--accent:#06b6d4}
  [data-theme="light"]{--bg:#f4f7fb;--card:#ffffff;--muted:#5b6470;--accent:#067fbf;color:#0b1220}
  [data-theme="rgb"]{--bg:linear-gradient(90deg,#ff4e50,#f9d423,#1fa2ff);--card:rgba(255,255,255,0.06);--muted:#fff;--accent:#fff;color:#fff}
  [data-theme="neon"]{--bg:#0a0a16;--card:#121230;--muted:#a0a0ff;--accent:#00f7ff;color:#e6f7ff}
  [data-theme="matrix"]{--bg:#000;--card:#001100;--muted:#00ff41;--accent:#00ff41;color:#00ff41}
  
  body{margin:0;background:var(--bg);color:var(--color, #e6eef6);font-family:'Segoe UI', system-ui, Arial, sans-serif;display:flex;align-items:center;justify-content:center;min-height:100vh;padding:18px;transition:all 0.3s ease}
  .card{width:100%;max-width:800px;background:var(--card);padding:24px;border-radius:16px;box-shadow:0 12px 40px rgba(0,0,0,0.7);border:1px solid rgba(255,255,255,0.05);position:relative;overflow:hidden}
  .card::before{content:'';position:absolute;top:0;left:0;right:0;height:4px;background:var(--accent);border-radius:16px 16px 0 0}
  
  h1{margin:0 0 15px;font-size:28px;font-weight:800;text-align:center;background:linear-gradient(90deg, var(--accent), #a78bfa);-webkit-background-clip:text;-webkit-text-fill-color:transparent;text-shadow:0 0 20px rgba(6,182,212,0.3)}
  
  .header-row{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;flex-wrap:wrap;gap:10px}
  
  .row{display:flex;gap:12px;align-items:center;margin-bottom:15px}
  input[type="text"]{flex:1;padding:12px 15px;border-radius:10px;border:1px solid rgba(255,255,255,0.1);background:rgba(255,255,255,0.05);color:inherit;font-size:16px;transition:all 0.2s}
  input[type="text"]:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 2px rgba(6,182,212,0.2)}
  
  #countBox{background:linear-gradient(145deg, var(--accent), #0ea5e9);color:#fff;padding:20px 30px;border-radius:16px;font-size:64px;font-weight:800;min-width:120px;text-align:center;transition:all 0.15s;display:inline-block;box-shadow:0 8px 25px rgba(6,182,212,0.3);text-shadow:0 2px 10px rgba(0,0,0,0.2);border:2px solid rgba(255,255,255,0.1)}
  
  .controls-main{display:flex;gap:15px;margin-top:25px;justify-content:center;flex-wrap:wrap}
  #spaceBtn{padding:20px 40px;border-radius:14px;background:linear-gradient(145deg, var(--accent), #0ea5e9);color:#022;font-weight:800;border:none;cursor:pointer;transition:0.2s;font-size:20px;box-shadow:0 8px 20px rgba(6,182,212,0.4);text-transform:uppercase;letter-spacing:1px;min-width:180px}
  #spaceBtn:hover{transform:translateY(-3px);box-shadow:0 12px 25px rgba(6,182,212,0.5)}
  #spaceBtn:active{transform:translateY(1px)}
  
  .controls-secondary{display:flex;gap:12px;margin-top:15px;justify-content:center;flex-wrap:wrap}
  button{padding:12px 20px;border-radius:10px;border:none;cursor:pointer;font-weight:600;transition:all 0.2s;font-size:15px}
  #startBtn{background:linear-gradient(145deg, #10b981, #059669);color:#fff;box-shadow:0 5px 15px rgba(16,185,129,0.3)}
  #endBtn{background:linear-gradient(145deg, #ef4444, #dc2626);color:#fff;box-shadow:0 5px 15px rgba(239,68,68,0.3)}
  #startBtn:hover, #endBtn:hover{transform:translateY(-2px)}
  #startBtn:active, #endBtn:active{transform:translateY(1px)}
  
  .hint{font-size:14px;color:var(--muted);margin-top:15px;text-align:center;padding:10px;background:rgba(255,255,255,0.03);border-radius:8px}
  
  .modal-bg{position:fixed;inset:0;background:rgba(2,6,23,0.8);display:flex;align-items:center;justify-content:center;z-index:50;backdrop-filter:blur(5px)}
  .modal{background:var(--card);padding:24px;border-radius:16px;width:100%;max-width:500px;position:relative;box-shadow:0 20px 60px rgba(0,0,0,0.5);border:1px solid rgba(255,255,255,0.1)}
  .close-x{position:absolute;top:12px;right:15px;background:transparent;border:0;color:var(--muted);font-weight:700;font-size:22px;cursor:pointer;padding:5px;border-radius:50%;width:32px;height:32px;display:flex;align-items:center;justify-content:center;transition:all 0.2s}
  .close-x:hover{background:rgba(255,255,255,0.1);color:#fff}
  .error{color:#ff6b6b;font-size:14px;margin-top:8px;display:none}
  .error.success{color:#10b981}
  .leaderboard{margin-top:15px;max-height:280px;overflow:auto;border-radius:10px;background:rgba(255,255,255,0.02);padding:10px;-webkit-overflow-scrolling:touch;scrollbar-width:thin;scrollbar-color:var(--accent) rgba(255,255,255,0.1)}
  .leaderboard::-webkit-scrollbar{width:6px}
  .leaderboard::-webkit-scrollbar-thumb{background:var(--accent);border-radius:3px}
  .top-item{display:flex;justify-content:space-between;padding:10px 12px;border-radius:8px;margin-bottom:8px;background:linear-gradient(90deg,rgba(255,255,255,0.03),transparent);transition:all 0.2s;align-items:center}
  .top-item:hover{background:linear-gradient(90deg,rgba(255,255,255,0.08),transparent);transform:translateX(5px)}
  .top-item .rank{font-weight:700;color:var(--accent);min-width:30px}
  .top-item .name{flex:1;display:flex;align-items:center;gap:8px;max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
  .top-item .score{font-weight:700;color:var(--accent)}
  .flag{width:20px;height:15px;border-radius:2px;box-shadow:0 0 3px rgba(0,0,0,0.3)}
  #resultModal .modal{max-width:700px}
  .confetti{position:fixed;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:100}
  
  .stats-bar{display:flex;justify-content:space-around;margin:20px 0;padding:15px;background:rgba(255,255,255,0.03);border-radius:12px;flex-wrap:wrap;gap:10px}
  .stat-item{text-align:center}
  .stat-value{font-size:24px;font-weight:700;color:var(--accent)}
  .stat-label{font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:1px}
  
  .theme-selector{display:flex;gap:8px;align-items:center}
  .theme-btn{width:24px;height:24px;border-radius:50%;cursor:pointer;border:2px solid transparent;transition:all 0.2s}
  .theme-btn.active{border-color:#fff;transform:scale(1.2)}
  .theme-btn[data-theme="dark"]{background:#071023}
  .theme-btn[data-theme="light"]{background:#f4f7fb}
  .theme-btn[data-theme="rgb"]{background:linear-gradient(90deg,#ff4e50,#f9d423,#1fa2ff)}
  .theme-btn[data-theme="neon"]{background:#0a0a16;box-shadow:0 0 10px #00f7ff}
  .theme-btn[data-theme="matrix"]{background:#000;box-shadow:0 0 10px #00ff41}
  
  .achievement-badge{position:absolute;top:20px;right:20px;background:gold;color:#000;padding:5px 10px;border-radius:20px;font-size:12px;font-weight:700;animation:pulse 2s infinite}
  @keyframes pulse{0%{transform:scale(1)}50%{transform:scale(1.1)}100%{transform:scale(1)}}
  
  .particles{position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:0}
  
  .countdown-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);display:flex;align-items:center;justify-content:center;z-index:1000;font-size:120px;font-weight:800;color:#fff;backdrop-filter:blur(10px)}
  .countdown-number{animation:zoomInOut 1s ease-in-out}
  @keyframes zoomInOut{0%{transform:scale(0);opacity:0}50%{transform:scale(1.2);opacity:1}100%{transform:scale(0);opacity:0}}
  
  .result-actions{display:flex;gap:10px;margin:15px 0;justify-content:center}
  .restart-btn{background:linear-gradient(145deg, #3b82f6, #1d4ed8);color:#fff;padding:10px 20px;border-radius:8px;border:none;cursor:pointer;font-weight:600}
  .restart-btn:hover{transform:translateY(-2px)}
  
  .player-flag{width:28px;height:20px;border-radius:3px;box-shadow:0 2px 4px rgba(0,0,0,0.3);display:inline-block;vertical-align:middle;margin-left:5px}
  
  .custom-confirm{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;z-index:1000;backdrop-filter:blur(5px)}
  .confirm-box{background:var(--card);padding:20px;border-radius:12px;max-width:400px;width:90%;text-align:center;border:1px solid rgba(255,255,255,0.1)}
  .confirm-buttons{display:flex;gap:10px;margin-top:20px;justify-content:center}
  .confirm-btn{padding:10px 20px;border-radius:8px;border:none;cursor:pointer;font-weight:600;min-width:80px}
  .confirm-yes{background:linear-gradient(145deg, #ef4444, #dc2626);color:#fff}
  .confirm-no{background:rgba(255,255,255,0.1);color:inherit}
  
  .country-selector{display:flex;align-items:center;gap:10px;margin:15px 0}
  .country-flag{width:30px;height:20px;border-radius:3px}
  .country-dropdown{padding:8px;border-radius:6px;background:rgba(255,255,255,0.05);color:inherit;border:1px solid rgba(255,255,255,0.1);flex:1}
  
  .sound-toggle{position:absolute;top:20px;right:70px;background:rgba(255,255,255,0.1);border:none;color:var(--muted);border-radius:50%;width:32px;height:32px;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:16px}
  
  .notification{position:fixed;top:10px;left:50%;transform:translateX(-50%);padding:10px 20px;background:#ff6b6b;color:#fff;border-radius:8px;font-size:14px;z-index:1001;box-shadow:0 4px 12px rgba(0,0,0,0.3);transition:opacity 0.5s}
  .notification.success{background:#10b981}
  
  .result-stats{display:grid;grid-template-columns:1fr 1fr;gap:15px;margin:15px 0}
  .stat-card{background:rgba(255,255,255,0.03);padding:15px;border-radius:8px;text-align:center;border:1px solid rgba(255,255,255,0.05)}
  .stat-card-value{font-size:24px;font-weight:700;color:var(--accent);margin-bottom:5px}
  .stat-card-label{font-size:12px;color:var(--muted);text-transform:uppercase}
  
  #resName{font-size:18px;font-weight:600}
  
  .particles::before{content:'';position:absolute;top:0;left:0;width:100%;height:100%;background:radial-gradient(circle, transparent 1px, var(--accent) 1px);background-size:20px 20px;animation:float 15s linear infinite;pointer-events:none;opacity:0.3}
  .confetti::before{content:'';position:absolute;top:0;left:0;width:100%;height:100%;background:linear-gradient(45deg, #ff0000 25%, transparent 25%, transparent 50%, #00ff00 50%, #00ff00 75%, transparent 75%, #0000ff);background-size:30px 30px;animation:confettiFall 2s ease-out forwards;pointer-events:none;opacity:0}
  
  @keyframes float{0%{transform:translateY(0px) translateX(0px)}100%{transform:translateY(-1000px) translateX(500px)}}
  @keyframes confettiFall{0%{transform:translateY(-100px) rotate(0deg);opacity:1}100%{transform:translateY(100vh) rotate(360deg);opacity:0}}
  
  @media(max-width:640px){
    .card{padding:18px}
    h1{font-size:24px}
    #countBox{font-size:40px;padding:12px 20px}
    #spaceBtn{padding:16px 30px;font-size:18px;min-width:200px}
    .header-row{flex-direction:column;align-items:flex-start}
    .stats-bar{gap:15px}
    .countdown-overlay{font-size:60px}
    .sound-toggle{top:15px;right:60px}
    .result-stats{grid-template-columns:1fr}
  }
</style>
</head>
<body data-theme="dark">

<div class="card" role="main" aria-label="Space Power">
  <div class="particles" id="particles"></div>
  
  <button class="sound-toggle" id="soundToggle" aria-label="Turn off sound effects">🔊</button>
  
  <h1>🚀 Space Power Tracker</h1>

  <div class="header-row">
    <div class="theme-selector">
      <div class="theme-btn active" data-theme="dark" title="Dark Theme" aria-label="Dark Theme"></div>
      <div class="theme-btn" data-theme="light" title="Light Theme" aria-label="Light Theme"></div>
      <div class="theme-btn" data-theme="rgb" title="RGB Theme" aria-label="RGB Theme"></div>
      <div class="theme-btn" data-theme="neon" title="Neon Theme" aria-label="Neon Theme"></div>
      <div class="theme-btn" data-theme="matrix" title="Matrix Theme" aria-label="Matrix Theme"></div>
    </div>
    <div style="font-size:14px;color:var(--muted);display:flex;align-items:center;gap:5px">
      <span>🔥 Trending Worldwide</span>
    </div>
  </div>

  <div class="row">
    <label style="min-width:70px;color:var(--muted);font-weight:600">Player Name</label>
    <input id="mainName" placeholder="Enter your name for global ranking" maxlength="50" aria-label="Enter your player name"/>
    <button id="prefillBtn" title="Fill last named" style="background:rgba(255,255,255,0.1);color:inherit" aria-label="Load last used name">Load Last</button>
  </div>

  <div class="country-selector">
    <img id="selectedFlag" src="https://flagcdn.com/w40/in.png" class="country-flag" alt="India flag">
    <select id="countrySelect" class="country-dropdown" aria-label="Country selector, currently selected: India">
      <option value="IN">India</option>
      <option value="US">United States</option>
      <option value="GB">United Kingdom</option>
      <option value="CA">Canada</option>
      <option value="AU">Australia</option>
      <option value="DE">Germany</option>
      <option value="FR">France</option>
      <option value="BR">Brazil</option>
      <option value="JP">Japan</option>
      <option value="KR">South Korea</option>
      <option value="CN">China</option>
      <option value="RU">Russia</option>
      <option value="IT">Italy</option>
      <option value="ES">Spain</option>
      <option value="MX">Mexico</option>
    </select>
  </div>

  <div class="stats-bar">
    <div class="stat-item">
      <div class="stat-value" id="statPresses">0</div>
      <div class="stat-label">Total Presses</div>
    </div>
    <div class="stat-item">
      <div class="stat-value" id="statRate">0.0</div>
      <div class="stat-label">Presses/Sec</div>
    </div>
    <div class="stat-item">
      <div class="stat-value" id="statTime">0s</div>
      <div class="stat-label">Time</div>
    </div>
    <div class="stat-item">
      <div class="stat-value" id="statRank">-</div>
      <div class="stat-label">Your Rank</div>
    </div>
  </div>

  <div style="text-align:center;margin-top:10px">
    <div id="countBox" aria-live="polite" aria-label="Current count: 0">0</div>
  </div>

  <div class="controls-main">
    <button id="spaceBtn" aria-label="Press Space or Click to increment count">🎯 PRESS SPACE</button>
  </div>

  <div class="controls-secondary">
    <button id="startBtn" aria-label="Start the game">▶ Start Game</button>
    <button id="endBtn" disabled aria-label="End the game">⏹ End Game</button>
    <button id="resetBtn" aria-label="Reset current game">🔄 Reset</button>
  </div>

  <div class="hint">Press <strong>SPACE</strong> or tap the button. Only one input counts at a time to prevent cheating!</div>

  <div style="margin-top:20px">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
      <strong style="font-size:16px">🏆 Global Top 10</strong>
      <button id="refreshLeaderboard" style="background:rgba(255,255,255,0.05);color:inherit;padding:6px 10px;font-size:12px" aria-label="Refresh leaderboard">Refresh</button>
    </div>
    <div class="leaderboard" id="leaderboardPreview"></div>
  </div>
</div>

<div id="customConfirm" class="custom-confirm" style="display:none" role="dialog" aria-labelledby="confirmTitle" aria-modal="true">
  <div class="confirm-box">
    <h3 style="margin-top:0" id="confirmTitle">Confirm Action</h3>
    <p id="confirmMessage">Are you sure you want to proceed?</p>
    <div class="confirm-buttons">
      <button class="confirm-btn confirm-yes" id="confirmYes">Yes</button>
      <button class="confirm-btn confirm-no" id="confirmNo">No</button>
    </div>
  </div>
</div>

<div id="countdownOverlay" class="countdown-overlay" style="display:none">
  <div id="countdownText">3</div>
</div>

<div id="nameModal" class="modal-bg" style="display:none" aria-modal="true">
  <div class="modal" role="dialog" aria-labelledby="modalTitle">
    <button class="close-x" id="modalX" aria-label="Close modal">✕</button>
    <h3 style="margin-top:0" id="modalTitle">Enter Your Name</h3>
    <p style="font-size:14px;color:var(--muted)">Enter your name to appear in the global leaderboard. Or press ✕ to play anonymously.</p>
    <input id="modalInput" placeholder="Your name" style="width:100%;box-sizing:border-box" maxlength="50" aria-label="Enter your name"/>
    <div class="error" id="modalError">Please enter a name or press ✕ to skip.</div>
    <div style="text-align:right;margin-top:15px">
      <button id="modalStart" aria-label="Start game with entered name">Start Game</button>
    </div>
  </div>
</div>

<div id="resultModal" class="modal-bg" style="display:none" aria-modal="true">
  <div class="modal" role="dialog" aria-labelledby="resultTitle">
    <button class="close-x" id="resultClose" aria-label="Close results">✕</button>
    <h3 style="margin-top:0" id="resultTitle">🎊 Game Results</h3>
    
    <div class="result-stats">
      <div class="stat-card">
        <div class="stat-card-value" id="resPresses">0</div>
        <div class="stat-card-label">Total Presses</div>
      </div>
      <div class="stat-card">
        <div class="stat-card-value" id="resTime">0s</div>
        <div class="stat-card-label">Time</div>
      </div>
      <div class="stat-card">
        <div class="stat-card-value" id="resRate">0.0/sec</div>
        <div class="stat-card-label">Speed</div>
      </div>
      <div class="stat-card">
        <div class="stat-card-value" id="resRank">-</div>
        <div class="stat-card-label">Global Rank</div>
      </div>
    </div>
    
    <div style="margin:15px 0;padding:10px;background:rgba(255,255,255,0.03);border-radius:8px;text-align:center">
      <strong>Player: </strong><span id="resName"></span>
    </div>
    
    <div class="result-actions">
      <button class="restart-btn" id="restartGame" aria-label="Play again">🔄 Play Again</button>
    </div>
    
    <div style="margin-top:15px">
      <strong style="font-size:16px">🏆 Global Top 10</strong>
      <div id="leaderboard" class="leaderboard" style="max-height:300px"></div>
    </div>
  </div>
</div>

<div id="confettiContainer" class="confetti"></div>

<script>
/* CONFIG */
const API_ENDPOINT = 'https://api.x.ai/v1/submit'; // Replace with your actual API endpoint
const STORAGE_KEY = 'sp_submissions_v7';
const QUEUE_KEY = 'sp_queue_v7';
const LAST_NAME_KEY = 'sp_last_name_v7';
const USER_COUNTRY_KEY = 'sp_user_country_v7';
const THEME_KEY = 'sp_theme';

/* STATE */
let playing = false, count = 0, startTime = 0, stamps = [], lastSpace = false;
let lastInputTs = 0, lastSaveTs = 0, timerInterval = null;
let inputLock = false, lastInputType = null;
let userCountry = 'IN';
let soundEnabled = true;
let audioContext = null;
let queueProcessing = false;
let currentModal = null;

/* DOM Elements */
const modal = document.getElementById('nameModal');
const modalX = document.getElementById('modalX');
const modalInput = document.getElementById('modalInput');
const modalStart = document.getElementById('modalStart');
const modalError = document.getElementById('modalError');
const mainName = document.getElementById('mainName');
const prefillBtn = document.getElementById('prefillBtn');
const countBox = document.getElementById('countBox');
const spaceBtn = document.getElementById('spaceBtn');
const startBtn = document.getElementById('startBtn');
const endBtn = document.getElementById('endBtn');
const resetBtn = document.getElementById('resetBtn');
const leaderboardEl = document.getElementById('leaderboard');
const leaderboardPreview = document.getElementById('leaderboardPreview');
const resultModal = document.getElementById('resultModal');
const resultClose = document.getElementById('resultClose');
const resName = document.getElementById('resName');
const resPresses = document.getElementById('resPresses');
const resTime = document.getElementById('resTime');
const resRate = document.getElementById('resRate');
const resRank = document.getElementById('resRank');
const confettiContainer = document.getElementById('confettiContainer');
const refreshLeaderboard = document.getElementById('refreshLeaderboard');
const statPresses = document.getElementById('statPresses');
const statRate = document.getElementById('statRate');
const statTime = document.getElementById('statTime');
const statRank = document.getElementById('statRank');
const particlesEl = document.getElementById('particles');
const countdownOverlay = document.getElementById('countdownOverlay');
const countdownText = document.getElementById('countdownText');
const customConfirm = document.getElementById('customConfirm');
const confirmTitle = document.getElementById('confirmTitle');
const confirmMessage = document.getElementById('confirmMessage');
const confirmYes = document.getElementById('confirmYes');
const confirmNo = document.getElementById('confirmNo');
const countrySelect = document.getElementById('countrySelect');
const selectedFlag = document.getElementById('selectedFlag');
const soundToggle = document.getElementById('soundToggle');
const restartGame = document.getElementById('restartGame');

/* COUNTRY FLAGS DATA */
const countryFlags = {
  'US': 'https://flagcdn.com/w40/us.png', 'IN': 'https://flagcdn.com/w40/in.png', 'GB': 'https://flagcdn.com/w40/gb.png',
  'CA': 'https://flagcdn.com/w40/ca.png', 'AU': 'https://flagcdn.com/w40/au.png', 'DE': 'https://flagcdn.com/w40/de.png',
  'FR': 'https://flagcdn.com/w40/fr.png', 'BR': 'https://flagcdn.com/w40/br.png', 'JP': 'https://flagcdn.com/w40/jp.png',
  'KR': 'https://flagcdn.com/w40/kr.png', 'CN': 'https://flagcdn.com/w40/cn.png', 'RU': 'https://flagcdn.com/w40/ru.png',
  'IT': 'https://flagcdn.com/w40/it.png', 'ES': 'https://flagcdn.com/w40/es.png', 'MX': 'https://flagcdn.com/w40/mx.png'
};

const countryNames = {
  'US': 'United States', 'IN': 'India', 'GB': 'United Kingdom', 'CA': 'Canada', 'AU': 'Australia',
  'DE': 'Germany', 'FR': 'France', 'BR': 'Brazil', 'JP': 'Japan', 'KR': 'South Korea',
  'CN': 'China', 'RU': 'Russia', 'IT': 'Italy', 'ES': 'Spain', 'MX': 'Mexico'
};

/* NOTIFICATION SYSTEM */
function showNotification(message, type = 'error') {
  const notification = document.createElement('div');
  notification.className = `notification ${type === 'success' ? 'success' : ''}`;
  notification.textContent = message;
  document.body.appendChild(notification);
  
  setTimeout(() => {
    notification.style.opacity = '0';
    setTimeout(() => notification.remove(), 500);
  }, 3000);
}

/* FOCUS TRAPPING FOR MODALS */
function trapFocus(modalElement, firstFocusable) {
  const focusableElements = modalElement.querySelectorAll('button, [href], input, select, textarea');
  const first = firstFocusable || focusableElements[0];
  const last = focusableElements[focusableElements.length - 1];
  
  const handleKeydown = (e) => {
    if (e.key === 'Tab') {
      if (e.shiftKey) {
        if (document.activeElement === first) {
          e.preventDefault();
          last.focus();
        }
      } else {
        if (document.activeElement === last) {
          e.preventDefault();
          first.focus();
        }
      }
    } else if (e.key === 'Escape') {
      closeCurrentModal();
    }
  };
  
  modalElement.addEventListener('keydown', handleKeydown);
  return () => modalElement.removeEventListener('keydown', handleKeydown);
}

function closeCurrentModal() {
  if (currentModal) {
    currentModal.style.display = 'none';
    if (soundEnabled) playSound('click');
    currentModal = null;
    document.removeEventListener('keydown', handleGlobalEscape);
  }
}

function handleGlobalEscape(e) {
  if (e.key === 'Escape') {
    closeCurrentModal();
  }
}

function showModal(modalElement, focusElement) {
  currentModal = modalElement;
  modalElement.style.display = 'flex';
  if (focusElement) focusElement.focus();
  const removeTrap = trapFocus(modalElement, focusElement);
  document.addEventListener('keydown', handleGlobalEscape);
  
  const observer = new MutationObserver((mutations) => {
    mutations.forEach((mutation) => {
      if (mutation.attributeName === 'style' && modalElement.style.display === 'none') {
        removeTrap();
        document.removeEventListener('keydown', handleGlobalEscape);
        observer.disconnect();
      }
    });
  });
  observer.observe(modalElement, { attributes: true });
}

/* SOUND SYSTEM */
function initAudio() {
  try {
    audioContext = new (window.AudioContext || window.webkitAudioContext)();
    
    const resumeAudio = () => {
      if (audioContext.state === 'suspended') {
        audioContext.resume();
      }
      document.removeEventListener('click', resumeAudio);
      document.removeEventListener('keydown', resumeAudio);
    };
    
    document.addEventListener('click', resumeAudio, { once: true });
    document.addEventListener('keydown', resumeAudio, { once: true });
  } catch (e) {
    soundEnabled = false;
    soundToggle.textContent = '🔇';
    soundToggle.setAttribute('aria-label', 'Sound effects not supported');
    showNotification('Sound effects not supported on this device', 'error');
  }
}

function playSound(type) {
  if (!soundEnabled || !audioContext) return;
  
  try {
    if (audioContext.state === 'suspended') {
      audioContext.resume();
    }
    
    const oscillator = audioContext.createOscillator();
    const gainNode = audioContext.createGain();
    
    oscillator.connect(gainNode);
    gainNode.connect(audioContext.destination);
    
    const frequencies = {
      'click': 800, 'start': 523.25, 'end': 392.00, 
      'countdown': 659.25, 'modal': 440, 'restart': 587.33
    };
    
    oscillator.frequency.setValueAtTime(frequencies[type] || 440, audioContext.currentTime);
    gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
    
    oscillator.start();
    gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 0.1);
    oscillator.stop(audioContext.currentTime + 0.1);
  } catch (e) {
    console.log('Sound error:', e);
  }
}

/* CUSTOM CONFIRM DIALOG */
function showConfirm(title, message) {
  return new Promise((resolve) => {
    confirmTitle.textContent = title;
    confirmMessage.textContent = message;
    showModal(customConfirm, confirmYes);
    
    if (soundEnabled) playSound('modal');
    
    const yesHandler = () => {
      customConfirm.style.display = 'none';
      confirmYes.removeEventListener('click', yesHandler);
      confirmNo.removeEventListener('click', noHandler);
      resolve(true);
    };
    
    const noHandler = () => {
      customConfirm.style.display = 'none';
      confirmYes.removeEventListener('click', yesHandler);
      confirmNo.removeEventListener('click', noHandler);
      resolve(false);
    };
    
    confirmYes.addEventListener('click', yesHandler);
    confirmNo.addEventListener('click', noHandler);
  });
}

/* COUNTRY SELECTION */
function updateCountryFlag() {
  const countryCode = countrySelect.value;
  userCountry = countryCode;
  selectedFlag.src = countryFlags[countryCode];
  selectedFlag.alt = countryNames[countryCode] + ' flag';
  countrySelect.setAttribute('aria-label', `Country selector, currently selected: ${countryNames[countryCode]}`);
  localStorage.setItem(USER_COUNTRY_KEY, countryCode);
}

countrySelect.addEventListener('change', updateCountryFlag);

/* THEME SYSTEM WITH SYSTEM PREFERENCE */
function applySystemTheme() {
  if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
    document.body.setAttribute('data-theme', 'dark');
    document.querySelectorAll('.theme-btn').forEach(btn => btn.classList.remove('active'));
    document.querySelector('.theme-btn[data-theme="dark"]').classList.add('active');
    localStorage.setItem(THEME_KEY, 'dark');
  }
}

document.querySelectorAll('.theme-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    const theme = btn.getAttribute('data-theme');
    document.body.setAttribute('data-theme', theme);
    localStorage.setItem(THEME_KEY, theme);
    document.querySelectorAll('.theme-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    createParticles();
  });
});

/* CSS-BASED PARTICLE EFFECT */
function createParticles() {
  const theme = document.body.getAttribute('data-theme');
  const isMobile = window.matchMedia('(max-width: 640px)').matches;
  if ((theme === 'rgb' || theme === 'neon' || theme === 'matrix') && !isMobile) {
    particlesEl.style.display = 'block';
  } else {
    particlesEl.style.display = 'none';
  }
}

/* NAME VALIDATION */
function validateName(name) {
  return /^[a-zA-Z0-9\s]{1,50}$/.test(name);
}

/* HELPERS */
function escapeHtml(s) {
  if (typeof s !== 'string') return '';
  return s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
}

function loadSubmissions() {
  try {
    const data = localStorage.getItem(STORAGE_KEY);
    if (!data) return [];
    const parsed = JSON.parse(data);
    return Array.isArray(parsed) ? parsed : [];
  } catch (e) {
    showNotification('Failed to load leaderboard data', 'error');
    return [];
  }
}

function saveSubmissions(arr) {
  try {
    const limitedArr = arr.slice(-800);
    localStorage.setItem(STORAGE_KEY, JSON.stringify(limitedArr));
  } catch (e) {
    if (e.name === 'QuotaExceededError') {
      showNotification('Storage full, keeping recent scores only', 'error');
      const limitedArr = arr.slice(-400);
      localStorage.setItem(STORAGE_KEY, JSON.stringify(limitedArr));
    } else {
      showNotification('Failed to save scores locally', 'error');
    }
  }
}

/* COUNTDOWN FUNCTION */
function startCountdown() {
  return new Promise((resolve) => {
    countdownOverlay.style.display = 'flex';
    let count = 3;
    
    const countdownInterval = setInterval(() => {
      if (count > 0) {
        countdownText.textContent = count;
        if (soundEnabled) playSound('countdown');
        count--;
      } else {
        countdownText.textContent = 'GO!';
        if (soundEnabled) playSound('start');
        setTimeout(() => {
          countdownOverlay.style.display = 'none';
          clearInterval(countdownInterval);
          resolve();
        }, 500);
      }
    }, 1000);
  });
}

/* CSS-BASED CONFETTI EFFECT */
function createConfetti() {
  confettiContainer.style.animation = 'confettiFall 2s ease-out forwards';
  setTimeout(() => {
    confettiContainer.style.animation = '';
  }, 2000);
}

/* API QUEUE SYSTEM */
function enqueuePayload(payload) {
  if (!API_ENDPOINT || API_ENDPOINT.includes('api.x.ai')) {
    showNotification('Cannot sync scores: API not configured. Saved locally.', 'error');
    return;
  }
  
  try {
    const q = JSON.parse(localStorage.getItem(QUEUE_KEY) || '[]');
    if (q.length >= 50) {
      q.shift();
    }
    
    const sanitizedPayload = {
      name: String(payload.name || '').substring(0, 50).replace(/[^\w\s]/gi, ''),
      presses: Math.min(Math.max(1, parseInt(payload.presses) || 1), 99999),
      duration_ms: Math.min(Math.max(1000, parseInt(payload.duration_ms) || 1000), 3600000),
      stamps: (Array.isArray(payload.stamps) ? payload.stamps : [])
        .slice(0, 50)
        .map(s => Math.max(0, Math.min(parseInt(s) || 0, 3600000)))
        .filter(s => s > 0 && s <= 3600000),
      ts: Math.max(Date.now() - 86400000, Math.min(parseInt(payload.ts) || Date.now(), Date.now() + 3600000)),
      country: countryFlags[payload.country] ? payload.country : 'US'
    };
    
    if (!sanitizedPayload.name || sanitizedPayload.presses < 1 || sanitizedPayload.duration_ms < 1000 || !sanitizedPayload.stamps.length) {
      showNotification('Invalid score data. Not saved for sync.', 'error');
      return;
    }
    
    q.push({
      payload: sanitizedPayload,
      tries: 0,
      nextTry: Date.now()
    });
    
    localStorage.setItem(QUEUE_KEY, JSON.stringify(q));
    processQueue();
  } catch (e) {
    console.error('Queue error:', e);
    showNotification('Failed to save score for sync', 'error');
  }
}

async function processQueue() {
  if (queueProcessing || !API_ENDPOINT || API_ENDPOINT.includes('api.x.ai')) {
    showNotification('Cannot sync scores: API not configured.', 'error');
    return;
  }
  queueProcessing = true;
  try {
    const q = JSON.parse(localStorage.getItem(QUEUE_KEY) || '[]');
    if (!q.length) {
      queueProcessing = false;
      return;
    }
    
    const now = Date.now();
    let processedAny = false;
    
    for (let i = 0; i < q.length; i++) {
      const item = q[i];
      if (item.nextTry > now) continue;
      
      if (item.tries >= 5) {
        q.splice(i, 1);
        i--;
        showNotification('Some scores failed to sync after retries.', 'error');
        continue;
      }
      
      try {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 8000);
        
        const response = await fetch(API_ENDPOINT, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(item.payload),
          signal: controller.signal
        });
        
        clearTimeout(timeoutId);
        
        if (response.ok) {
          q.splice(i, 1);
          i--;
          processedAny = true;
          showNotification('Score synced successfully!', 'success');
          continue;
        }
        
        if (response.status === 429) {
          showNotification('Too many requests. Retrying later.', 'error');
          item.nextTry = now + 60000;
        } else if (response.status >= 500) {
          showNotification('Server error. Retrying later.', 'error');
          item.nextTry = now + 30000;
        } else {
          showNotification(`Sync failed: ${response.statusText}`, 'error');
          item.tries++;
          item.nextTry = now + Math.min(30000, Math.pow(2, item.tries) * 2000);
        }
      } catch (err) {
        if (err.name === 'AbortError') {
          showNotification('Network timeout. Retrying later.', 'error');
        } else {
          showNotification('Sync error. Retrying later.', 'error');
        }
        item.tries++;
        item.nextTry = now + Math.min(30000, Math.pow(2, item.tries) * 2000);
      }
    }
    
    localStorage.setItem(QUEUE_KEY, JSON.stringify(q));
    
    if (processedAny && q.length > 0) {
      setTimeout(processQueue, 2000);
    } else if (q.length > 0) {
      setTimeout(processQueue, 15000);
    }
  } catch (e) {
    showNotification('Failed to sync scores with server.', 'error');
    console.error('Queue error:', e);
    setTimeout(processQueue, 30000);
  }
  queueProcessing = false;
}

/* LEADERBOARD FUNCTIONS */
function getNamedSorted() {
  try {
    const arr = loadSubmissions();
    return arr
      .filter(x => x.name && x.name !== 'Anonymous' && x.presses > 0)
      .sort((a, b) => b.presses - a.presses || a.duration_ms - b.duration_ms);
  } catch (e) {
    return [];
  }
}

function updateLeaderboard(element, data) {
  try {
    element.innerHTML = '';
    if (!data.length) {
      element.innerHTML = '<div style="color:var(--muted);text-align:center;padding:20px">No submissions yet. Be the first!</div>';
      return;
    }
    
    data.forEach((p, i) => {
      const div = document.createElement('div');
      div.className = 'top-item';
      div.innerHTML = `
        <div class="rank">#${i+1}</div>
        <div class="name">
          <img src="${p.country ? countryFlags[p.country] : countryFlags['US']}" 
               class="flag" alt="${countryNames[p.country] || 'United States'}" 
               onerror="this.src='${countryFlags['US']}'">
          ${escapeHtml(p.name)}
        </div>
        <div class="score">${p.presses}</div>
      `;
      element.appendChild(div);
    });
  } catch (e) {
    element.innerHTML = '<div style="color:var(--muted);text-align:center;padding:20px">Error loading leaderboard</div>';
  }
}

function updateLeaderboardPreview() {
  const top = getNamedSorted().slice(0, 10);
  updateLeaderboard(leaderboardPreview, top);
}

/* MODAL LOGIC */
startBtn.addEventListener('click', async () => {
  if (soundEnabled) playSound('start');
  const nm = mainName.value.trim();
  if (!nm) {
    showModal(modal, modalInput);
    return;
  }
  
  if (!validateName(nm)) {
    showNotification('Name can only contain letters, numbers, and spaces', 'error');
    return;
  }
  
  await beginSession(nm);
});

modalInput.addEventListener('input', () => {
  modalError.style.display = 'none';
  modalInput.value = modalInput.value.substring(0, 50);
  if (!validateName(modalInput.value)) {
    modalError.textContent = 'Only letters, numbers, and spaces allowed';
    modalError.style.display = 'block';
    modalError.classList.remove('success');
  } else if (modalInput.value.trim()) {
    modalError.textContent = 'Looks good!';
    modalError.style.display = 'block';
    modalError.classList.add('success');
  }
});

modalStart.addEventListener('click', async () => {
  if (soundEnabled) playSound('start');
  const v = modalInput.value.trim();
  if (!v) {
    modalError.textContent = 'Please enter a name or press ✕ to skip';
    modalError.style.display = 'block';
    modalError.classList.remove('success');
    return;
  }
  
  if (!validateName(v)) {
    modalError.textContent = 'Only letters, numbers, and spaces allowed';
    modalError.style.display = 'block';
    modalError.classList.remove('success');
    return;
  }
  
  mainName.value = v;
  modal.style.display = 'none';
  await beginSession(v);
});

modalX.addEventListener('click', () => {
  modal.style.display = 'none';
  beginSession('Anonymous');
});

prefillBtn.addEventListener('click', () => {
  const last = localStorage.getItem(LAST_NAME_KEY);
  if (last) mainName.value = last;
  if (soundEnabled) playSound('click');
});

refreshLeaderboard.addEventListener('click', () => {
  updateLeaderboardPreview();
  if (soundEnabled) playSound('click');
});

/* SESSION MANAGEMENT */
async function beginSession(name) {
  if (playing) return;
  
  await startCountdown();
  
  playing = true;
  count = 0;
  stamps = [];
  startTime = Date.now();
  lastSpace = false;
  inputLock = false;
  lastInputType = null;
  countBox.textContent = '0';
  countBox.setAttribute('aria-label', 'Current count: 0');
  countBox.style.width = '120px';
  endBtn.disabled = false;
  startBtn.disabled = true;
  
  statPresses.textContent = '0';
  statRate.textContent = '0.0';
  statTime.textContent = '0s';
  
  if (timerInterval) clearInterval(timerInterval);
  timerInterval = setInterval(updateStats, 200);
  
  if (name && name !== 'Anonymous') {
    try {
      localStorage.setItem(LAST_NAME_KEY, name.substring(0, 50));
    } catch (e) {
      console.error('Error saving name:', e);
    }
  }
  
  if (!localStorage.getItem('sp_first_game')) {
    localStorage.setItem('sp_first_game', 'true');
    setTimeout(() => {
      const badge = document.createElement('div');
      badge.className = 'achievement-badge';
      badge.textContent = 'First Game!';
      document.querySelector('.card').appendChild(badge);
      setTimeout(() => badge.remove(), 3000);
    }, 1000);
  }
}

function updateStats() {
  if (!playing) return;
  
  const duration_ms = Date.now() - startTime;
  const seconds = duration_ms / 1000;
  const rate = seconds > 0 ? (count / seconds).toFixed(1) : '0.0';
  
  statPresses.textContent = count;
  statRate.textContent = rate;
  statTime.textContent = Math.floor(seconds) + 's';
}

/* INCREMENT LOGIC WITH ENHANCED INPUT LOCK */
function increment(inputType) {
  if (!playing || inputLock) return;
  
  const now = Date.now();
  if (now - lastInputTs < 30) {
    // If another input type was recently processed, block this one
    if (lastInputType !== inputType) {
      showNotification('Only one input counts at a time!', 'error');
      return;
    }
  }
  
  inputLock = true;
  lastInputTs = now;
  lastInputType = inputType;
  
  count++;
  countBox.textContent = String(count);
  countBox.setAttribute('aria-label', `Current count: ${count}`);
  countBox.style.width = Math.max(120, 100 + String(count).length * 18) + 'px';
  stamps.push(Date.now() - startTime);
  
  if (soundEnabled) playSound('click');
  
  const theme = document.body.getAttribute('data-theme');
  if (theme === 'matrix') {
    spaceBtn.style.background = 'linear-gradient(145deg, #00ff41, #00cc33)';
  } else if (theme === 'neon') {
    spaceBtn.style.background = 'linear-gradient(145deg, #00f7ff, #00aaff)';
  } else {
    const r = Math.floor(Math.random() * 206) + 50;
    const g = Math.floor(Math.random() * 206) + 50;
    const b = Math.floor(Math.random() * 206) + 50;
    spaceBtn.style.background = `linear-gradient(145deg, rgb(${r}, ${g}, ${b}), rgb(${r-30}, ${g-30}, ${b-30}))`;
  }
  
  if (Date.now() - lastSaveTs > 5000) {
    lastSaveTs = Date.now();
    try {
      localStorage.setItem('sp_current', JSON.stringify({
        name: (mainName.value || 'Anonymous').substring(0, 50),
        count: Math.min(count, 99999),
        stamps: stamps.slice(-1000),
        startTime
      }));
    } catch (e) {
      console.error('Auto-save error:', e);
    }
  }
  
  setTimeout(() => {
    inputLock = false;
    lastInputType = null; // Reset input type after lock expires
  }, 30);
}

/* INPUT CONTROLS */
spaceBtn.addEventListener('click', e => {
  e.preventDefault();
  increment('mouse');
});

spaceBtn.addEventListener('touchstart', e => {
  e.preventDefault();
  increment('mouse');
});

document.addEventListener('keydown', e => {
  if ((e.code === 'Space' || e.key === ' ') && !lastSpace) {
    e.preventDefault();
    lastSpace = true;
    increment('space');
  }
});

document.addEventListener('keyup', e => {
  if (e.code === 'Space' || e.key === ' ') {
    lastSpace = false;
  }
});

/* RESET BUTTON */
resetBtn.addEventListener('click', async () => {
  if (soundEnabled) playSound('click');
  
  if (playing) {
    const confirmed = await showConfirm(
      'Reset Game',
      'Are you sure you want to reset? Your current progress will be lost.'
    );
    
    if (confirmed) {
      playing = false;
      count = 0;
      stamps = [];
      inputLock = false;
      lastInputType = null;
      countBox.textContent = '0';
      countBox.setAttribute('aria-label', 'Current count: 0');
      countBox.style.width = '120px';
      endBtn.disabled = true;
      startBtn.disabled = false;
      spaceBtn.style.background = 'linear-gradient(145deg, var(--accent), #0ea5e9)';
      
      if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
      }
      
      statPresses.textContent = '0';
      statRate.textContent = '0.0';
      statTime.textContent = '0s';
      localStorage.removeItem('sp_current');
    }
  } else {
    count = 0;
    inputLock = false;
    lastInputType = null;
    countBox.textContent = '0';
    countBox.setAttribute('aria-label', 'Current count: 0');
    countBox.style.width = '120px';
    spaceBtn.style.background = 'linear-gradient(145deg, var(--accent), #0ea5e9)';
    
    statPresses.textContent = '0';
    statRate.textContent = '0.0';
    statTime.textContent = '0s';
    localStorage.removeItem('sp_current');
  }
});

/* END SESSION */
endBtn.addEventListener('click', () => {
  if (!playing) return;
  playing = false;
  inputLock = false;
  lastInputType = null;
  endBtn.disabled = true;
  startBtn.disabled = false;
  
  if (timerInterval) {
    clearInterval(timerInterval);
    timerInterval = null;
  }
  
  if (soundEnabled) playSound('end');
  
  const duration_ms = Date.now() - startTime;
  const seconds = Math.floor(duration_ms / 1000);
  const timeText = Math.floor(seconds / 60) + 'm ' + (seconds % 60) + 's';
  const rate = (count / (duration_ms / 1000)).toFixed(1);
  const player = (mainName.value.trim() || 'Anonymous').substring(0, 50);
  
  if (player !== 'Anonymous') {
    try {
      const arr = loadSubmissions();
      arr.push({
        name: player,
        presses: count,
        duration_ms,
        ts: Date.now(),
        country: userCountry
      });
      saveSubmissions(arr);
      localStorage.setItem(LAST_NAME_KEY, player);
      localStorage.removeItem('sp_current');
    } catch (e) {
      showNotification('Failed to save score locally', 'error');
    }
  }
  
  let rankText = '-';
  let rankNum = null;
  if (player !== 'Anonymous') {
    const named = getNamedSorted();
    const higher = named.filter(x => x.presses > count).length;
    const rank = higher + 1;
    rankNum = rank;
    rankText = `#${rank}`;
    
    statRank.textContent = `#${rank}`;
    
    if (rankNum <= 10) {
      let msg = '';
      if (rankNum === 1) {
        msg = "🏆 CONGRATULATIONS! You're #1 in the world! Legendary!";
        createConfetti();
      } else if (rankNum === 2) {
        msg = "🔥 Amazing! You're #2 globally! So close to the top!";
        createConfetti();
      } else if (rankNum === 3) {
        msg = "⭐ Fantastic! You're #3 worldwide! Top tier performance!";
        createConfetti();
      } else {
        msg = `🎯 Excellent! You're #${rankNum} globally! Top 10 achiever!`;
      }
      setTimeout(() => showNotification(msg, 'success'), 300);
    }
  }
  
  resName.innerHTML = escapeHtml(player) + (player !== 'Anonymous' ? 
    ` <img src="${countryFlags[userCountry]}" class="player-flag" alt="${countryNames[userCountry]}">` : '');
  resPresses.textContent = count;
  resTime.textContent = timeText;
  resRate.textContent = rate + '/sec';
  resRank.textContent = rankText;
  
  const top = getNamedSorted().slice(0, 10);
  updateLeaderboard(leaderboardEl, top);
  
  showModal(resultModal, restartGame);
  
  const payload = {
    name: player,
    presses: count,
    duration_ms,
    stamps: stamps.slice(-50),
    ts: Date.now(),
    country: userCountry
  };
  enqueuePayload(payload);
  
  updateLeaderboardPreview();
});

/* CLOSE RESULT MODAL */
resultClose.addEventListener('click', () => {
  resultModal.style.display = 'none';
  count = 0;
  inputLock = false;
  lastInputType = null;
  countBox.textContent = '0';
  countBox.setAttribute('aria-label', 'Current count: 0');
  stamps = [];
  endBtn.disabled = true;
  startBtn.disabled = false;
  spaceBtn.style.background = 'linear-gradient(145deg, var(--accent), #0ea5e9)';
  localStorage.removeItem('sp_current');
});

/* RESTART GAME BUTTON */
restartGame.addEventListener('click', () => {
  if (soundEnabled) playSound('restart');
  
  resultModal.style.display = 'none';
  count = 0;
  inputLock = false;
  lastInputType = null;
  countBox.textContent = '0';
  countBox.setAttribute('aria-label', 'Current count: 0');
  stamps = [];
  endBtn.disabled = true;
  startBtn.disabled = false;
  spaceBtn.style.background = 'linear-gradient(145deg, var(--accent), #0ea5e9)';
  localStorage.removeItem('sp_current');
  
  setTimeout(() => {
    const nm = mainName.value.trim();
    if (nm) {
      beginSession(nm);
    } else {
      startBtn.disabled = false;
    }
  }, 500);
});

/* SOUND TOGGLE */
soundToggle.addEventListener('click', () => {
  soundEnabled = !soundEnabled;
  soundToggle.textContent = soundEnabled ? '🔊' : '🔇';
  soundToggle.setAttribute('aria-label', soundEnabled ? 'Turn off sound effects' : 'Turn on sound effects');
  localStorage.setItem('sp_sound_enabled', soundEnabled.toString());
  if (soundEnabled) playSound('click');
});

/* INITIALIZATION */
function initApp() {
  const savedTheme = localStorage.getItem(THEME_KEY);
  if (savedTheme) {
    document.body.setAttribute('data-theme', savedTheme);
    document.querySelectorAll('.theme-btn').forEach(btn => btn.classList.remove('active'));
    document.querySelector(`.theme-btn[data-theme="${savedTheme}"]`).classList.add('active');
  } else {
    applySystemTheme();
  }
  
  const savedCountry = localStorage.getItem(USER_COUNTRY_KEY) || 'IN';
  const savedSound = localStorage.getItem('sp_sound_enabled');
  
  userCountry = savedCountry;
  countrySelect.value = savedCountry;
  updateCountryFlag();
  
  if (savedSound !== null) {
    soundEnabled = savedSound === 'true';
    soundToggle.textContent = soundEnabled ? '🔊' : '🔇';
    soundToggle.setAttribute('aria-label', soundEnabled ? 'Turn off sound effects' : 'Turn on sound effects');
  }
  
  initAudio();
  updateLeaderboardPreview();
  createParticles();
  
  const savedGame = localStorage.getItem('sp_current');
  if (savedGame) {
    try {
      const { name, count: savedCount, stamps: savedStamps, startTime: savedStart } = JSON.parse(savedGame);
      if (name && savedCount > 0 && savedStamps.length > 0 && savedStart) {
        mainName.value = name;
        count = savedCount;
        stamps = savedStamps;
        startTime = savedStart;
        playing = true;
        countBox.textContent = String(count);
        countBox.setAttribute('aria-label', `Current count: ${count}`);
        countBox.style.width = Math.max(120, 100 + String(count).length * 18) + 'px';
        endBtn.disabled = false;
        startBtn.disabled = true;
        timerInterval = setInterval(updateStats, 200);
        updateStats();
        showNotification('Resumed your previous game!', 'success');
      }
    } catch (e) {
      console.error('Error loading saved game:', e);
      localStorage.removeItem('sp_current');
    }
  }
  
  const q = JSON.parse(localStorage.getItem(QUEUE_KEY) || '[]');
  if (q.length > 0 && API_ENDPOINT && !API_ENDPOINT.includes('api.x.ai')) {
    processQueue();
    setInterval(processQueue, 30000);
  }
}

/* SERVICE WORKER REGISTRATION */
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('/sw.js')
      .then(registration => {
        console.log('SW registered: ', registration);
      })
      .catch(registrationError => {
        console.log('SW registration failed: ', registrationError);
      });
  });
}

window.addEventListener('DOMContentLoaded', () => {
  const last = localStorage.getItem(LAST_NAME_KEY);
  if (last) mainName.value = last;
  
  initApp();
});

modal.addEventListener('click', (e) => {
  if (e.target === modal) {
    modal.style.display = 'none';
  }
});

resultModal.addEventListener('click', (e) => {
  if (e.target === resultModal) {
    resultModal.style.display = 'none';
  }
});

customConfirm.addEventListener('click', (e) => {
  if (e.target === customConfirm) {
    customConfirm.style.display = 'none';
  }
});
</script>
</body>
</html>
